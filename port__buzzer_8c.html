<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Jukebox Project: port/stm32f4/src/port_buzzer.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Jukebox Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('port__buzzer_8c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">port_buzzer.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Portable functions to interact with the buzzer melody player FSM library.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;math.h&gt;</code><br />
<code>#include &quot;<a class="el" href="port__buzzer_8h.html">port_buzzer.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a2a49f7f72ccc4b0d80601926cbe2373d"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="port__buzzer_8c.html#a2a49f7f72ccc4b0d80601926cbe2373d">ALT_FUNC2_TIM3</a></td></tr>
<tr class="separator:a2a49f7f72ccc4b0d80601926cbe2373d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a8a74a67606394c1c78a37b674c7ea8d1"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="port__buzzer_8c.html#a8a74a67606394c1c78a37b674c7ea8d1">_timer_duration_setup</a> (uint32_t buzzer_id)</td></tr>
<tr class="memdesc:a8a74a67606394c1c78a37b674c7ea8d1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Configure the timer that controls the duration of the note.  <a href="port__buzzer_8c.html#a8a74a67606394c1c78a37b674c7ea8d1">More...</a><br /></td></tr>
<tr class="separator:a8a74a67606394c1c78a37b674c7ea8d1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9468700f1074dff44680f6d29d6f09c4"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="port__buzzer_8c.html#a9468700f1074dff44680f6d29d6f09c4">_timer_pwm_setup</a> (uint32_t buzzer_id)</td></tr>
<tr class="memdesc:a9468700f1074dff44680f6d29d6f09c4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Configure the timer that controls the PWM of the buzzer.  <a href="port__buzzer_8c.html#a9468700f1074dff44680f6d29d6f09c4">More...</a><br /></td></tr>
<tr class="separator:a9468700f1074dff44680f6d29d6f09c4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae0607400eb9b14cf11f0d2b521ad86d0"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="port__buzzer_8c.html#ae0607400eb9b14cf11f0d2b521ad86d0">port_buzzer_set_note_duration</a> (uint32_t buzzer_id, uint32_t duration_ms)</td></tr>
<tr class="memdesc:ae0607400eb9b14cf11f0d2b521ad86d0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set the duration of the timer that controls the duration of the note.  <a href="port__buzzer_8c.html#ae0607400eb9b14cf11f0d2b521ad86d0">More...</a><br /></td></tr>
<tr class="separator:ae0607400eb9b14cf11f0d2b521ad86d0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3084fd2623e9e89c1b959b5f5e7e20c9"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="port__buzzer_8c.html#a3084fd2623e9e89c1b959b5f5e7e20c9">port_buzzer_set_note_frequency</a> (uint32_t buzzer_id, double frequency_hz)</td></tr>
<tr class="memdesc:a3084fd2623e9e89c1b959b5f5e7e20c9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set the PWM frequency of the timer that controls the frequency of the note.  <a href="port__buzzer_8c.html#a3084fd2623e9e89c1b959b5f5e7e20c9">More...</a><br /></td></tr>
<tr class="separator:a3084fd2623e9e89c1b959b5f5e7e20c9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a385f66c71f8918fefffc28e71bcbe989"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="port__buzzer_8c.html#a385f66c71f8918fefffc28e71bcbe989">port_buzzer_get_note_timeout</a> (uint32_t buzzer_id)</td></tr>
<tr class="memdesc:a385f66c71f8918fefffc28e71bcbe989"><td class="mdescLeft">&#160;</td><td class="mdescRight">Retrieve the status of the note end flag.  <a href="port__buzzer_8c.html#a385f66c71f8918fefffc28e71bcbe989">More...</a><br /></td></tr>
<tr class="separator:a385f66c71f8918fefffc28e71bcbe989"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a272b4e6cb82c7d00d575361a442b9c6b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="port__buzzer_8c.html#a272b4e6cb82c7d00d575361a442b9c6b">port_buzzer_stop</a> (uint32_t buzzer_id)</td></tr>
<tr class="memdesc:a272b4e6cb82c7d00d575361a442b9c6b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Disable the PWM output of the timer that controls the frequency of the note and the timer that controls the duration of the note.  <a href="port__buzzer_8c.html#a272b4e6cb82c7d00d575361a442b9c6b">More...</a><br /></td></tr>
<tr class="separator:a272b4e6cb82c7d00d575361a442b9c6b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a37c661d72c1cd58acb59a26ccf318c5a"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="port__buzzer_8c.html#a37c661d72c1cd58acb59a26ccf318c5a">port_buzzer_init</a> (uint32_t buzzer_id)</td></tr>
<tr class="memdesc:a37c661d72c1cd58acb59a26ccf318c5a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Configure the HW specifications of a given buzzer melody player.  <a href="port__buzzer_8c.html#a37c661d72c1cd58acb59a26ccf318c5a">More...</a><br /></td></tr>
<tr class="separator:a37c661d72c1cd58acb59a26ccf318c5a"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a7af932ad5c44fae7e29f4f09fddf495a"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structport__buzzer__hw__t.html">port_buzzer_hw_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="port__buzzer_8c.html#a7af932ad5c44fae7e29f4f09fddf495a">buzzers_arr</a> []</td></tr>
<tr class="memdesc:a7af932ad5c44fae7e29f4f09fddf495a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Array of elements that represents the HW characteristics of the buzzers.  <a href="port__buzzer_8c.html#a7af932ad5c44fae7e29f4f09fddf495a">More...</a><br /></td></tr>
<tr class="separator:a7af932ad5c44fae7e29f4f09fddf495a"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Portable functions to interact with the buzzer melody player FSM library. </p>
<dl class="section author"><dt>Author</dt><dd>Sistemas Digitales II </dd></dl>
<dl class="section date"><dt>Date</dt><dd>2024-01-01 </dd></dl>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a2a49f7f72ccc4b0d80601926cbe2373d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2a49f7f72ccc4b0d80601926cbe2373d">&#9670;&nbsp;</a></span>ALT_FUNC2_TIM3</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define ALT_FUNC2_TIM3</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>TIM3 Alternate Function mapping </p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a8a74a67606394c1c78a37b674c7ea8d1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8a74a67606394c1c78a37b674c7ea8d1">&#9670;&nbsp;</a></span>_timer_duration_setup()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void _timer_duration_setup </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>buzzer_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Configure the timer that controls the duration of the note. </p>
<p>This function is called by the <code><a class="el" href="port__buzzer_8c.html#a37c661d72c1cd58acb59a26ccf318c5a" title="Configure the HW specifications of a given buzzer melody player.">port_buzzer_init()</a></code> public function to configure the timer that controls the duration of the note.</p>
<p>Because there could be several notes playing at the same time, each buzzer melody player has its own timer. So, the timer to be configured is selected by the <code>buzzer_id</code> parameter, and you **must encapsulate the configuration of the timer in a <code>switch</code> or <code>if</code> statement.*</p>
<blockquote class="doxtable">
<p><b>TO-DO alumnos:</b></p>
<p>âœ… 1. Enable the clock source of the timer <br  />
&#160;&#160;&#160;&#160;ðŸ’¡ To know if the source clock is <code>APB1</code> or <code>APB2</code>, check the clock tree in the datasheet (<a href="https://www.st.com/en/microcontrollers-microprocessors/stm32f446re.html">Figure 3. STM32F446xC/E block diagram</a>) <br  />
âœ… 2. Disable the counter (register <code>CR1</code>) and enable the autoreload preaload (register <code>ARPE</code>) âœ… 3. Clean the Update Interrupt flag (register <code>SR</code>) <br  />
âœ… 4. Enable the Update Interrupt (register <code>DIER</code>) <br  />
</p><ol type="1">
<li>Set the priority of the interrupt to <code>1</code> and the subpriority to <code>0</code> <br  />
</li>
<li>Enable the interrupt in the NVIC <br  />
</li>
</ol>
</blockquote>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">buzzer_id</td><td></td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a9468700f1074dff44680f6d29d6f09c4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9468700f1074dff44680f6d29d6f09c4">&#9670;&nbsp;</a></span>_timer_pwm_setup()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void _timer_pwm_setup </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>buzzer_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Configure the timer that controls the PWM of the buzzer. </p>
<p>This function is called by the <code><a class="el" href="port__buzzer_8c.html#a37c661d72c1cd58acb59a26ccf318c5a" title="Configure the HW specifications of a given buzzer melody player.">port_buzzer_init()</a></code> public function to configure the timer that controls the PWM of the buzzer. Because there could be several notes playing at the same time, each buzzer melody player has its own timer. So, the timer to be configured is selected by the <code>buzzer_id</code> parameter, and you **must encapsulate the configuration of the timer in a <code>switch</code> or <code>if</code> statement.*</p>
<blockquote class="doxtable">
<p><b>TO-DO alumnos:</b></p>
<p><b>PWM timer setup</b> âœ… 1. Enable the clock source of the timer <br  />
&#160;&#160;&#160;&#160;ðŸ’¡ To know if the source clock is <code>APB1</code> or <code>APB2</code>, check the clock tree in the datasheet (<a href="https://www.st.com/en/microcontrollers-microprocessors/stm32f446re.html">Figure 3. STM32F446xC/E block diagram</a>) <br  />
âœ… 2. Disable the counter (register <code>CR1</code>) and enable the autoreload preaload (register <code>ARPE</code>) âœ… 3. Reset the counter (register <code>CNT</code>), set the autoreload value (register <code>ARR</code>) and the prescaler (register <code>PSC</code>) to 0 <br  />
âœ… 4. Generate an update event (register <code>EGR</code>) by setting the <code>UG</code> bit. This will load the values of the <code>ARR</code> and <code>PSC</code> registers into the active registers. <br  />
 <b>PWM mode configuration</b> âœ… 5. Disable the output compare of the corresponding channel (register <code>CCER</code>). Take into account the channel number (1 or 2) and the channel enable bit (CC1E or CC2E) <br  />
âœ… 6. Set both (i) mode PWM 1, and (ii) enable preload (register CCMRx) &#160;&#160;&#160;&#160;ðŸ’¡ To know which register <code>CCMRx</code> to use check the "Table 11. Alternate function" in the datasheet. <br  />
</p>
</blockquote>
<p>It is not needed to set the PWM pulse width and period here. It will be set with the note frequency.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">buzzer_id</td><td></td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a385f66c71f8918fefffc28e71bcbe989"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a385f66c71f8918fefffc28e71bcbe989">&#9670;&nbsp;</a></span>port_buzzer_get_note_timeout()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool port_buzzer_get_note_timeout </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>buzzer_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Retrieve the status of the note end flag. </p>
<blockquote class="doxtable">
<p><b>TO-DO alumnos:</b></p>
<p>âœ… 1. Return the value of the <code>note_end</code> flag if the buzzer ID is valid. Otherwise, return false. <br  />
</p>
</blockquote>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">buzzer_id</td><td>Buzzer melody player ID. This index is used to select the element of the <code>buzzers_arr[]</code> array </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>true </dd>
<dd>
false </dd></dl>

</div>
</div>
<a id="a37c661d72c1cd58acb59a26ccf318c5a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a37c661d72c1cd58acb59a26ccf318c5a">&#9670;&nbsp;</a></span>port_buzzer_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void port_buzzer_init </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>buzzer_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Configure the HW specifications of a given buzzer melody player. </p>
<blockquote class="doxtable">
<p><b>TO-DO alumnos:</b></p>
<p>âœ… 1. Call functions to configure the GPIOs and the alternate functions of them. Set no pull up neither pull down connection <br  />
âœ… 2. Configure the timers calling the <b>private</b> functions <code><a class="el" href="port__buzzer_8c.html#a8a74a67606394c1c78a37b674c7ea8d1" title="Configure the timer that controls the duration of the note.">_timer_duration_setup()</a></code> and <code><a class="el" href="port__buzzer_8c.html#a9468700f1074dff44680f6d29d6f09c4" title="Configure the timer that controls the PWM of the buzzer.">_timer_pwm_setup()</a></code> <br  />
</p>
</blockquote>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">buzzer_id</td><td>Buzzer melody player ID. This index is used to select the element of the <code>buzzers_arr[]</code> array </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="ae0607400eb9b14cf11f0d2b521ad86d0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae0607400eb9b14cf11f0d2b521ad86d0">&#9670;&nbsp;</a></span>port_buzzer_set_note_duration()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void port_buzzer_set_note_duration </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>buzzer_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>duration_ms</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set the duration of the timer that controls the duration of the note. </p>
<p>This function is called by the <code><a class="el" href="fsm__buzzer_8c.html#a9d2ee57bf248ca0e856ecbb6ee65f402" title="Start a note by setting the PWM frequency and the timer duration.">_start_note()</a></code> private function to set the duration of the note in milliseconds.</p>
<p>Because there could be several notes playing at the same time, each buzzer melody player has its own timer. So, the timer to be configured is selected by the <code>buzzer_id</code> parameter, and you <b>must encapsulate the configuration of the timer in a <code>switch</code> or <code>if</code> statement.</b></p>
<p><b>Use the timer indicated in the <a href="index.html">main page</a>.</b></p>
<dl class="section warning"><dt>Warning</dt><dd>It is important to <b>work with double type numbers to avoid the loss of precision</b> when computing the temporary values of the <code>ARR</code> and <code>PSC</code> registers. The <code>math.h</code> library is included to use the <code>round()</code> function. <br  />
To store the temporary values of the <code>ARR</code> and <code>PSC</code> registers, <b>cast the result of the <code>round()</code> function to <code>uint32_t</code></b>. <br  />
<b>All the values must be represented as double in the formulas.</b> <br  />
Example of C code: <div class="fragment"><div class="line"><span class="preprocessor">#include &lt;math.h&gt;</span></div>
<div class="line">...</div>
<div class="line">double sysclk_as_double = (double)<a class="code" href="port__system_8c.html#aa3cd3e43291e81e795d642b79b6088e6">SystemCoreClock</a>; <span class="comment">// Important to cast to double</span></div>
<div class="line"><span class="keywordtype">double</span> ms_as_double = (double)duration_ms; <span class="comment">// Important to cast to double</span></div>
<div class="line"><span class="keywordtype">double</span> what_ever_formula = (sysclk_as_double / ms_as_double) + 1.0; <span class="comment">// Important to use 1.0 instead of 1!!! This formula is just an example!!!</span></div>
<div class="line">TIMx-&gt;ARR = (uint32_t)(round(temp_value)); <span class="comment">// Important to round before casting to uint32_t</span></div>
</div><!-- fragment --></dd></dl>
<blockquote class="doxtable">
<p><b>TO-DO alumnos:</b></p>
<p>âœ… 1. Disable the timer and reset the counter <br  />
âœ… 2. Convert <code>duration_ms</code> and <code>SystemCoreClock</code> to double and store them in local variables. This is to ensure that the subsequent calculations are performed in floating-point arithmetic. <br  />
âœ… 3. Compute an initial value for the <code>PSC</code> register considering the maximum value of <code>ARR</code> (65535.0). Store it in a local variable of type <code>double</code>. <br  />
&#160;&#160;&#160;&#160;ðŸ’¡ This would make <code>ARR</code> less than or equal to 65535.0, and we will adjust <code>ARR</code> and <code>PSC</code> if necessary. This eliminates the need for a loop, which could be slow if <code>ARR</code> is much larger than 0xFFFF. <br  />
&#160;&#160;&#160;&#160;ðŸ’¡ Use all variable and numbers as <code>double</code> (i.e., use 1.0 instead of 1). <br  />
&#160;&#160;&#160;&#160;ðŸ’¡ To minimize the error, round the value using the function <code>round()</code> from the <code>math.h</code> library. Do not cast, casting trunks the decimal value. <br  />
âœ… 4. Compute the value of the <code>ARR</code> register with the previously computed <code>PSC</code> value. Store it in a local variable of type <code>double</code>. <br  />
&#160;&#160;&#160;&#160;ðŸ’¡ To minimize the error, round the value using the function <code>round()</code>. <br  />
âœ… 5. Check if the value computed of <code>ARR</code> is greater than 0xFFFF (or 65535.0). If it is, increment <code>PSC</code> by 1.0 and recalculate <code>ARR</code>. This is to ensure that <code>ARR</code> does not exceed 0xFFFF. <br  />
âœ… 6. Load the temporary values computed for <code>ARR</code> and <code>PSC</code> into the corresponding registers of the timer. <br  />
&#160;&#160;&#160;&#160;ðŸ’¡ Ensure that values are rounded before casting. <br  />
âœ… 7. The <code>PSC</code> and <code>ARR</code> values are currently in the preload registers. To load them into the active registers we need an update event. We achieve this by setting the <code>UG</code> bit of the <code>EGR</code> register. It is important to do this at the end of the configuration of the timer. <br  />
âœ… 8. Set the <code>note_end</code> flag to the appropriate value. <br  />
âœ… 9. Enable the timer. <br  />
</p>
</blockquote>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">buzzer_id</td><td>Buzzer melody player ID. This index is used to select the element of the <code>buzzers_arr[]</code> array </td></tr>
    <tr><td class="paramname">duration_ms</td><td>Duration of the note in ms </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a3084fd2623e9e89c1b959b5f5e7e20c9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3084fd2623e9e89c1b959b5f5e7e20c9">&#9670;&nbsp;</a></span>port_buzzer_set_note_frequency()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void port_buzzer_set_note_frequency </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>buzzer_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>frequency_hz</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set the PWM frequency of the timer that controls the frequency of the note. </p>
<p>This function is called by the <code><a class="el" href="fsm__buzzer_8c.html#a9d2ee57bf248ca0e856ecbb6ee65f402" title="Start a note by setting the PWM frequency and the timer duration.">_start_note()</a></code> private function to set the frequency of the note in Hz.</p>
<p>Because there could be several notes playing at the same time, each buzzer melody player has its own timer. So, the timer to be configured is selected by the <code>buzzer_id</code> parameter, and you **must encapsulate the configuration of the timer in a <code>switch</code> or <code>if</code> statement.*</p>
<p><b>Use the timer indicated in the <a href="index.html">main page</a>.</b></p>
<dl class="section warning"><dt>Warning</dt><dd>It is important to <b>work with double type numbers to avoid the loss of precision</b> when computing the temporary values of the <code>ARR</code> and <code>PSC</code> registers. The <code>math.h</code> library is included to use the <code>round()</code> function. <br  />
</dd></dl>
<blockquote class="doxtable">
<p><b>TO-DO alumnos:</b></p>
<p>Similar to the <code><a class="el" href="port__buzzer_8h.html#ae0607400eb9b14cf11f0d2b521ad86d0" title="Set the duration of the timer that controls the duration of the note.">port_buzzer_set_note_duration()</a></code> function, you must configure the timer that controls the frequency of the note: <br  />
âœ… 1. If the frequency is 0, disable the timer and return <br  />
âœ… 2. Disable the timer and reset the counter <br  />
âœ… 3. Convert <code>SystemCoreClock</code> to double and store it in local variables. This is to ensure that the subsequent calculations are performed in floating-point arithmetic. <br  />
âœ… 4. Compute an initial value for the <code>PSC</code> register considering the maximum value of <code>ARR</code> (65535.0). Store it in a local variable of type <code>double</code>. <br  />
&#160;&#160;&#160;&#160;ðŸ’¡ This would make <code>ARR</code> less than or equal to 65535.0, and we will adjust <code>ARR</code> and <code>PSC</code> if necessary. This eliminates the need for a loop, which could be slow if <code>ARR</code> is much larger than 0xFFFF. <br  />
&#160;&#160;&#160;&#160;ðŸ’¡ Use all variable and numbers as <code>double</code> (i.e., use 1.0 instead of 1). <br  />
&#160;&#160;&#160;&#160;ðŸ’¡ To minimize the error, round the value using the function <code>round()</code> from the <code>math.h</code> library. Do not cast, casting trunks the decimal value. <br  />
âœ… 5. Compute the value of the <code>ARR</code> register with the previously computed <code>PSC</code> value. Store it in a local variable of type <code>double</code>. <br  />
&#160;&#160;&#160;&#160;ðŸ’¡ To minimize the error, round the value using the function <code>round()</code>. <br  />
âœ… 6. Check if the value computed of <code>ARR</code> is greater than 0xFFFF (or 65535.0). If it is, increment <code>PSC</code> by 1.0 and recalculate <code>ARR</code>. This is to ensure that <code>ARR</code> does not exceed 0xFFFF. <br  />
âœ… 7. Load the temporary values computed for <code>ARR</code> and <code>PSC</code> into the corresponding registers of the timer. <br  />
&#160;&#160;&#160;&#160;ðŸ’¡ Ensure that values are rounded before casting. <br  />
âœ… 8. Set the PWM pulse width to <code>BUZZER_PWM_DC</code>. <br  />
âœ… 9. The <code>PSC</code> and <code>ARR</code> values are currently in the preload registers. To load them into the active registers we need an update event. We achieve this by setting the <code>UG</code> bit of the <code>EGR</code> register. It is important to do this at the end of the configuration of the timer. <br  />
âœ… 10. Enable the output compare in the capture/compare mode register of the timer. <br  />
&#160;&#160;&#160;&#160;ðŸ’¡ Be careful to select the correct channel. Remember that, the channel is defined in the Alternate function table of the datasheet. <br  />
âœ… 11. Enable the timer <br  />
</p>
</blockquote>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">buzzer_id</td><td>Buzzer melody player ID. This index is used to select the element of the <code>buzzers_arr[]</code> array </td></tr>
    <tr><td class="paramname">frequency_hz</td><td>Frequency of the note in Hz </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a272b4e6cb82c7d00d575361a442b9c6b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a272b4e6cb82c7d00d575361a442b9c6b">&#9670;&nbsp;</a></span>port_buzzer_stop()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void port_buzzer_stop </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>buzzer_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Disable the PWM output of the timer that controls the frequency of the note and the timer that controls the duration of the note. </p>
<blockquote class="doxtable">
<p><b>TO-DO alumnos:</b></p>
<p>âœ… 1. If the buzzer ID is valid, disable the PWM output of the timer that controls the frequency of the note and also the timer that controls the duration of the note. <br  />
</p>
</blockquote>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">buzzer_id</td><td>Buzzer melody player ID. This index is used to select the element of the <code>buzzers_arr[]</code> array </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a7af932ad5c44fae7e29f4f09fddf495a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7af932ad5c44fae7e29f4f09fddf495a">&#9670;&nbsp;</a></span>buzzers_arr</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structport__buzzer__hw__t.html">port_buzzer_hw_t</a> buzzers_arr[]</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Array of elements that represents the HW characteristics of the buzzers. </p>
<p>This is an <b>extern</b> variable that is declared in <code><a class="el" href="port__buzzer_8h.html" title="Header for port_buzzer.c file.">port_buzzer.h</a></code>. </p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="aport__system_8c_html_aa3cd3e43291e81e795d642b79b6088e6"><div class="ttname"><a href="port__system_8c.html#aa3cd3e43291e81e795d642b79b6088e6">SystemCoreClock</a></div><div class="ttdeci">uint32_t SystemCoreClock</div><div class="ttdef"><b>Definition:</b> port_system.c:18</div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_651562d8bf6cfd3e81eff5b570d7df50.html">port</a></li><li class="navelem"><a class="el" href="dir_aff93352f483d815f4aad2ce8569e33b.html">stm32f4</a></li><li class="navelem"><a class="el" href="dir_96ea3e7ce74ccff9e7229beeb516906f.html">src</a></li><li class="navelem"><a class="el" href="port__buzzer_8c.html">port_buzzer.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
